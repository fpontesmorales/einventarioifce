{% extends "vistoria/base_vistoria.html" %}
{% block title %}Sala — {{ sala.nome }}{% endblock %}

{% block content %}

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div>
        <div class="muted">Sala</div>
        <div style="font-weight:700">{{ sala.nome }}{% if sala.bloco %} — {{ sala.bloco }}{% endif %}</div>
      </div>
      <a class="btn" href="{% url 'vistoria_public:salas_por_bloco' bloco=sala.bloco|default:'SEM BLOCO' %}">← Voltar ao bloco</a>
    </div>

    <div class="muted" style="margin-top:6px;">
      Total elegíveis: <strong>{{ total_elegiveis }}</strong> — Vistoriados: <strong>{{ vistoriados_count }}</strong> ({{ pct_vistoriado }}%)
    </div>

    <div class="progress" style="margin:8px 0;">
      <div class="bar" style="width: {{ pct_vistoriado }}%;"></div>
    </div>

    <div class="grid" style="grid-template-columns: 1fr; gap:8px;">
      <form method="post" action="{% url 'vistoria_public:vistoriar_por_tombo' sala_id=sala.id %}">
        {% csrf_token %}
        <input name="tombamento" type="text" placeholder="Digite o tombamento e tecle Enter…" autofocus />
      </form>
      <div class="top-actions">
        <a class="btn primary" href="{% url 'vistoria_public:extra_novo' sala_id=sala.id %}">+ Item sem registro</a>
      </div>
    </div>
  </div>

  {% if nao_vistoriados %}
    <div class="card">
      <div class="group-title">Não vistoriados ({{ nao_vistoriados|length }})</div>
      <ul>
        {% for b in nao_vistoriados %}
          <li class="item">
            <a href="{% url 'vistoria_public:vistoria_bem_form' sala_id=sala.id tombamento=b.tombamento %}">
              <strong>{{ b.tombamento }}</strong> — {{ b.descricao|default:"(sem descrição)" }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if vistoriados_ok %}
    <div class="card ok">
      <div class="group-title">Vistoriados (sem divergência) ({{ vistoriados_ok|length }})</div>
      <ul>
        {% for b,v in vistoriados_ok %}
          <li class="item ok">
            <a href="{% url 'vistoria_public:vistoria_bem_form' sala_id=sala.id tombamento=b.tombamento %}">
              <strong>{{ b.tombamento }}</strong> — {{ b.descricao|default:"(sem descrição)" }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if vistoriados_div %}
    <div class="card div">
      <div class="group-title">Vistoriados (com divergência) ({{ vistoriados_div|length }})</div>
      <ul>
        {% for b,v in vistoriados_div %}
          <li class="item div">
            <a href="{% url 'vistoria_public:vistoria_bem_form' sala_id=sala.id tombamento=b.tombamento %}">
              <strong>{{ b.tombamento }}</strong> — {{ b.descricao|default:"(sem descrição)" }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if nao_encontrados %}
    <div class="card na">
      <div class="group-title">Não encontrados ({{ nao_encontrados|length }})</div>
      <ul>
        {% for b,v in nao_encontrados %}
          <li class="item na">
            <a href="{% url 'vistoria_public:vistoria_bem_form' sala_id=sala.id tombamento=b.tombamento %}">
              <strong>{{ b.tombamento }}</strong> — {{ b.descricao|default:"(sem descrição)" }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if recebidos_aqui %}
    <div class="card mv">
      <div class="group-title">Cadastrados no SUAP em outra sala (vistoriados aqui) ({{ recebidos_aqui|length }})</div>
      <ul>
        {% for b,v in recebidos_aqui %}
          {% with b.sala|default:"—" as suap %}
            <li class="item mv">
              <a href="{% url 'vistoria_public:vistoria_bem_form' sala_id=sala.id tombamento=b.tombamento %}">
                <strong>{{ b.tombamento }}</strong> — {{ b.descricao|default:"(sem descrição)" }}
              </a>
              <div class="muted">No SUAP: {{ suap }}</div>
            </li>
          {% endwith %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if movidos %}
    <div class="card mv">
      <div class="group-title">Encontrados em outra sala ({{ movidos|length }})</div>
      <ul>
        {% for b,v in movidos %}
          <li class="item mv">
            <a href="{% url 'vistoria_public:vistoria_bem_form' sala_id=sala.id tombamento=b.tombamento %}">
              <strong>{{ b.tombamento }}</strong> — {{ b.descricao|default:"(sem descrição)" }}
            </a>
            <div class="muted">Observado em: {{ v.sala_obs_nome }}{% if v.sala_obs_bloco %} — {{ v.sala_obs_bloco }}{% endif %}</div>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if extras %}
    <div class="card sr">
      <div class="group-title">Itens sem registro ({{ extras|length }})</div>
      <ul>
        {% for x in extras %}
          <li class="item sr" style="list-style:none;">
            <details>
              <summary style="cursor:pointer;">
                <strong>SEM TOMBO</strong> — {{ x.descricao_obs|default:"(sem descrição)" }}
              </summary>

              <div style="margin-top:8px;">
                {% if x.numero_serie_obs %}
                  <p><strong>Nº de série:</strong> {{ x.numero_serie_obs }}</p>
                {% endif %}

                {% if x.estado_obs %}
                  <p><strong>Estado:</strong> {{ x.estado_obs }}</p>
                {% endif %}

                {% if x.responsavel_obs %}
                  <p><strong>Responsável:</strong> {{ x.responsavel_obs }}</p>
                {% endif %}

                <p>
                  <strong>Etiqueta:</strong>
                  {% if x.etiqueta_possui %}Sim{% else %}Não{% endif %}
                  {% if x.etiqueta_condicao %} — {{ x.etiqueta_condicao }}{% endif %}
                </p>

                {% if x.observacoes %}
                  <p class="muted"><strong>Observações:</strong> {{ x.observacoes }}</p>
                {% endif %}

                {% if x.foto_marcadagua %}
                  <div style="margin-top:12px;">
                    <img src="{{ x.foto_marcadagua.url }}" alt="Foto do item sem registro"
                         style="max-width:100%;border-radius:12px;border:1px solid #e5e7eb;">
                  </div>
                {% endif %}
              </div>
            </details>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

{% endblock %}
