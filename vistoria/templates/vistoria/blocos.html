{# vistoria/templates/vistoria/blocos.html #}
{% extends "vistoria/base_vistoria.html" %}
{% block title %}Blocos — Vistoria{% endblock %}

{% block page_prefix %}<i class="bi bi-clipboard-check"></i> Vistorias{% endblock %}
{% block page_title %}Blocos{% endblock %}
{% block page_subtitle %}Pesquise uma sala ou entre em um bloco.{% endblock %}

{% block page_toolbar %}
<div class="mt-3">
  {# Busca global (GET) + atualização instantânea das SALAS via fetch #}
  <form method="get" id="formBusca">
    <div class="input-group">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="search"
             class="form-control"
             id="q"
             name="q"
             value="{{ q }}"
             placeholder="Pesquisar sala…"
             autocomplete="off">
      <button class="btn btn-primary" type="submit">
        <i class="bi bi-search"></i> Buscar
      </button>
      <button class="btn btn-outline-secondary" type="button" id="btnLimpar">
        <i class="bi bi-x-circle"></i> Limpar
      </button>
    </div>
    <div class="form-text mt-1">
      Digite para ver <strong>salas</strong> em tempo real. “Buscar” executa a pesquisa no servidor.
    </div>
  </form>
</div>
{% endblock %}

{% block content %}

  {# --- SALAS ENCONTRADAS (renderizamos a casca sempre; conteúdo é trocado via fetch) --- #}
  <div class="card shadow-sm mb-3 {% if not salas_encontradas and not q %}d-none{% endif %}" id="boxSalasFound">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-semibold">
          <i class="bi bi-list-check"></i> Salas encontradas
        </div>
        <span class="badge text-bg-secondary" id="badgeCountSalas">
          {% if salas_encontradas %}{{ salas_encontradas|length }}{% else %}0{% endif %}
        </span>
      </div>

      <div id="listSalasFound" class="list-group">
        {% if salas_encontradas %}
          {% for s in salas_encontradas %}
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
               data-search="{{ s.nome }} {{ s.bloco|default:'' }}"
               href="{% url 'vistoria_public:sala_workspace' sala_id=s.id %}">
              <span><i class="bi bi-door-open"></i> {{ s.nome }}{% if s.bloco %} — {{ s.bloco }}{% endif %}</span>
              <span class="text-primary"><i class="bi bi-box-arrow-in-right"></i></span>
            </a>
          {% endfor %}
        {% endif %}
      </div>

      <div class="alert alert-light border my-2 {% if salas_encontradas %}d-none{% endif %}" id="emptySalasFound">
        Nenhuma sala corresponde ao filtro atual.
      </div>
    </div>
  </div>

  {# --- GRID DE BLOCOS (some quando há texto na busca) --- #}
  <div id="gridBlocosBox" class="{% if q %}d-none{% endif %}">
    <div id="gridBlocos" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
      {% for c in cards %}
        <div class="col">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start">
                <div class="fw-semibold text-wrap">
                  <i class="bi bi-building"></i> {{ c.bloco }}
                </div>
                <a class="btn btn-outline-primary btn-sm"
                   href="{% url 'vistoria_public:salas_por_bloco' bloco=c.bloco %}">
                  <i class="bi bi-box-arrow-in-right"></i> Entrar
                </a>
              </div>

              <div class="d-flex justify-content-between text-muted small mt-2">
                <div><span class="fw-semibold">{{ c.total }}</span> elegíveis</div>
                <div>{{ c.vistoriados }} vistoriados</div>
              </div>

              <div class="progress my-2" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-label="Progresso">
                {% with pct=0 %}
                  {% if c.total > 0 %}{% widthratio c.vistoriados c.total 100 as pct %}{% endif %}
                  <div class="progress-bar" style="width: {{ pct }}%">{{ pct }}%</div>
                {% endwith %}
              </div>

              <div class="mt-auto d-flex flex-wrap gap-2 text-muted small">
                <span class="badge text-bg-light"><i class="bi bi-hourglass-split"></i> Pendentes: {{ c.pendentes }}</span>
                <span class="badge text-bg-light"><i class="bi bi-x-circle"></i> Não encontrados: {{ c.nao_encontrados }}</span>
                <span class="badge text-bg-light"><i class="bi bi-arrow-left-right"></i> Movidos: {{ c.movidos }}</span>
                <span class="badge text-bg-light"><i class="bi bi-clipboard-plus"></i> Sem reg.: {{ c.sem_registro }}</span>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

{% endblock %}

{% block extra_js %}
<script>
(function(){
  const inp  = document.getElementById('q');
  const btnL = document.getElementById('btnLimpar');

  const boxSalas   = document.getElementById('boxSalasFound');
  const listSalas  = document.getElementById('listSalasFound');
  const emptySalas = document.getElementById('emptySalasFound');
  const badgeCount = document.getElementById('badgeCountSalas');

  const gridBox = document.getElementById('gridBlocosBox');

  let controller = null;
  let debounceId = null;
  let lastValue  = inp ? inp.value.trim() : '';

  function toggleViews(showSalas){
    if (showSalas) {
      boxSalas.classList.remove('d-none');
      gridBox.classList.add('d-none');
    } else {
      boxSalas.classList.add('d-none');
      gridBox.classList.remove('d-none');
    }
  }

  function updateSalasFromDoc(doc){
    const newList  = doc.getElementById('listSalasFound');
    const newEmpty = doc.getElementById('emptySalasFound');
    const newBadge = doc.getElementById('badgeCountSalas');

    // Se a página retornada não tiver o bloco (ex.: sem resultados), limpamos.
    listSalas.innerHTML = newList ? newList.innerHTML : '';
    if (badgeCount) badgeCount.textContent = newBadge ? newBadge.textContent : '0';

    const hasItems = !!listSalas.querySelector('.list-group-item');
    emptySalas.classList.toggle('d-none', hasItems);
  }

  function fetchSalas(q){
    if (controller) controller.abort();
    controller = new AbortController();

    const url = new URL(window.location.href);
    url.searchParams.set('q', q);

    fetch(url.toString(), { signal: controller.signal, headers: { 'X-Requested-With': 'fetch' } })
      .then(r => r.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        updateSalasFromDoc(doc);
        toggleViews(true);
      })
      .catch(err => { if (err.name !== 'AbortError') { /* silencioso */ } });
  }

  function onInput(){
    const q = (inp.value || '').trim();
    if (q === '') {
      toggleViews(false);
      lastValue = '';
      return;
    }
    if (q === lastValue) return;
    lastValue = q;
    clearTimeout(debounceId);
    debounceId = setTimeout(() => fetchSalas(q), 200);
  }

  if (inp) {
    inp.addEventListener('input', onInput);
    // Estado inicial
    if (inp.value.trim() !== '') {
      fetchSalas(inp.value.trim());
    } else {
      toggleViews(false);
    }
  }

  if (btnL) {
    btnL.addEventListener('click', () => {
      inp.value = '';
      lastValue = '';
      toggleViews(false);
      inp.focus();
    });
  }
})();
</script>
{% endblock %}
