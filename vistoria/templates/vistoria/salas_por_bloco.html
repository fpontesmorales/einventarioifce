{# vistoria/templates/vistoria/salas_por_bloco.html #}
{% extends "vistoria/base_vistoria.html" %}
{% block title %}Salas — {{ bloco }}{% endblock %}

{% block page_prefix %}<i class="bi bi-building"></i> Bloco{% endblock %}
{% block page_title %}{{ bloco }}{% endblock %}
{% block page_subtitle %}Salas deste bloco.{% endblock %}

{% block page_actions %}
  <a class="btn btn-outline-secondary" href="{% url 'vistoria_public:blocos' %}">
    <i class="bi bi-arrow-left"></i> Voltar aos blocos
  </a>
{% endblock %}

{% block page_toolbar %}
<div class="mt-3">
  <div class="input-group" id="toolbar-salas">
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="search" class="form-control" id="inpSalas" placeholder="Filtrar salas por nome…" autocomplete="off">
    <button type="button" class="btn btn-outline-secondary" id="btnFiltroSalas">
      <i class="bi bi-funnel"></i> Filtrar
    </button>
  </div>
  <div class="form-text mt-1">Digite para filtrar as salas deste bloco (sem recarregar).</div>
</div>
{% endblock %}

{% block content %}
  <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3" id="gridSalas">
    {% for it in items %}
      <div class="col"
           data-search="{{ it.sala.nome }} {{ it.total }} {{ it.vistoriados }} {{ it.pendentes }} {{ it.movidos_fora }} {{ it.movidos_recebidos }} {{ it.sem_registro }}">
        <div class="card h-100 shadow-sm">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
              <div class="fw-semibold"><i class="bi bi-door-open"></i> {{ it.sala.nome }}</div>
              <a class="btn btn-outline-primary btn-sm"
                 href="{% url 'vistoria_public:sala_workspace' sala_id=it.sala.id %}">
                 <i class="bi bi-box-arrow-in-right"></i> Entrar
              </a>
            </div>

            <div class="d-flex justify-content-between text-muted small mt-2">
              <div><span class="fw-semibold">{{ it.total }}</span> elegíveis</div>
              <div>{{ it.vistoriados }} vistoriados</div>
            </div>

            <div class="progress my-2" role="progressbar" aria-valuemin="0" aria-valuemax="100">
              {% with pct=0 %}{% if it.total > 0 %}{% widthratio it.vistoriados it.total 100 as pct %}{% endif %}
              <div class="progress-bar" style="width: {{ pct }}%">{{ pct }}%</div>{% endwith %}
            </div>

            <div class="mt-auto d-flex flex-wrap gap-2 text-muted small">
              <span class="badge text-bg-light"><i class="bi bi-hourglass-split"></i> Pend.: {{ it.pendentes }}</span>
              <span class="badge text-bg-light"><i class="bi bi-arrow-left-right"></i> Mov. fora: {{ it.movidos_fora }}</span>
              <span class="badge text-bg-light"><i class="bi bi-sign-turn-right"></i> Recebidos: {{ it.movidos_recebidos }}</span>
              <span class="badge text-bg-light"><i class="bi bi-clipboard-plus"></i> Sem reg.: {{ it.sem_registro }}</span>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const inp = document.getElementById('inpSalas');
  const btn = document.getElementById('btnFiltroSalas');
  const items = document.querySelectorAll('#gridSalas [data-search]');

  function apply(){
    const q = (inp.value || '').toLowerCase();
    items.forEach(el=>{
      const hay = (el.getAttribute('data-search') || '').toLowerCase();
      el.classList.toggle('d-none', !hay.includes(q));
    });
  }
  if (inp) inp.addEventListener('input', apply);
  if (btn) btn.addEventListener('click', apply);
})();
</script>
{% endblock %}
