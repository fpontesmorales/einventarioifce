{% extends "admin/base_site.html" %}
{% load static relatorio_extras %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
  /* Cores impressas fiéis */
  * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

  /* Cabeçalho da tabela “grudado” em tela; desliga no print */
  .tbl-sticky thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 2; }

  /* Imagens de gráficos só no print (se houver canvases na página) */
  .chart-print-img { display: none; }

  @media print {
    .tbl-sticky thead th { position: static !important; top: auto !important; z-index: auto !important; }
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }
    th, td { background-clip: padding-box; }
    /* Esconder canvas e exibir snapshots */
    canvas { display: none !important; }
    .chart-print-img { display: block !important; max-width: 100%; height: auto; }
  }
</style>
{% endblock %}

{% block content %}
<main class="container-fluid py-3">

  <!-- Cabeçalho institucional -->
  <section class="py-3 border-bottom mb-3">
    <div class="d-flex align-items-center gap-3">
      {% if cfg and cfg.logo %}
        <img src="{{ cfg.logo.url }}" alt="Logo" style="height:64px; width:auto;">
      {% endif %}
      <div class="flex-grow-1">
        <h1 class="h4 mb-1">Inventário — Relatório Final</h1>
        <div class="text-muted">IFCE – Campus Caucaia</div>
        <div class="small mt-1">
          <strong>SEI:</strong> {{ SEI }} &nbsp;|&nbsp;
          <strong>Portaria:</strong> {{ PORTARIA }} &nbsp;|&nbsp;
          <strong>Período:</strong> {{ PERIODO }}
        </div>
      </div>
      <div>
        <a class="btn btn-outline-secondary" href="#" onclick="window.print();return false;">Imprimir / PDF</a>
      </div>
    </div>
  </section>

  <!-- Apresentação -->
  {% if cfg and cfg.texto_apresentacao %}
  <section class="card mb-3">
    <div class="card-header"><h2 class="h5 mb-0">Apresentação</h2></div>
    <div class="card-body">
      <p style="white-space: pre-wrap;">{% render_vars cfg.texto_apresentacao %}</p>
    </div>
  </section>
  {% endif %}

  <!-- Metodologia -->
  {% if cfg and cfg.texto_metodologia %}
  <section class="card mb-3">
    <div class="card-header"><h2 class="h5 mb-0">Metodologia</h2></div>
    <div class="card-body">
      <p style="white-space: pre-wrap;">{% render_vars cfg.texto_metodologia %}</p>
    </div>
  </section>
  {% endif %}

  <!-- Resultados -->
  <section class="card">
    <div class="card-header"><h2 class="h5 mb-0">Resultados</h2></div>
    <div class="card-body">
      {% include "relatorios/_andamento_cards.html" %}

      <!-- KPIs principais (somente Bootstrap) -->
      {% if kpis %}
      <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-6 g-3 mb-3">
        <div class="col">
          <div class="card h-100 border-danger">
            <div class="card-body">
              <div class="text-muted small">Não encontrados</div>
              <div class="fs-4 fw-semibold">
                {{ kpis.nao_itens }}
                <span class="small text-muted">({{ kpis.nao_valor|br_currency }})</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card h-100 border-primary">
            <div class="card-body">
              <div class="text-muted small">Cobertura</div>
              <div class="fs-4 fw-semibold">{{ kpis.cobertura|br_percent }}</div>
              <div class="progress mt-2" role="progressbar" aria-valuenow="{{ kpis.cobertura }}" aria-valuemin="0" aria-valuemax="100" style="height:.5rem;">
                <div class="progress-bar" style="width: {{ kpis.cobertura }}%;"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card h-100">
            <div class="card-body">
              <div class="text-muted small">Vistoriados</div>
              <div class="fs-4 fw-semibold">{{ kpis.vist_itens }}</div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card h-100 border-warning">
            <div class="card-body">
              <div class="text-muted small">Divergentes</div>
              <div class="fs-4 fw-semibold">
                {{ kpis.div_itens }}
                <span class="small text-muted">({{ kpis.div_valor|br_currency }})</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card h-100">
            <div class="card-body">
              <div class="text-muted small">SUAP (itens)</div>
              <div class="fs-4 fw-semibold">{{ kpis.suap_itens }}</div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card h-100">
            <div class="card-body">
              <div class="text-muted small">SUAP (R$)</div>
              <div class="fs-4 fw-semibold">{{ kpis.suap_valor|br_currency }}</div>
            </div>
          </div>
        </div>
      </div>
      {% else %}
        <p>Sem dados para o inventário ativo.</p>
      {% endif %}

      {% if kpis and kpis.cobertura < 5 %}
        <div class="alert alert-info">
          Cobertura preliminar (&lt; 5%). Os gráficos abaixo são exibidos para facilitar o acompanhamento, mas podem mudar significativamente à medida que a vistoria avança.
        </div>
      {% endif %}

      <!-- “Gráficos” com componentes Bootstrap -->
      <div class="row g-3">
        <!-- Cobertura por conta -->
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-header"><h3 class="h6 mb-0">Cobertura por Conta (top 12)</h3></div>
            <div class="card-body">
              {% if graficos.cobertura_por_conta %}
                {% for it in graficos.cobertura_por_conta %}
                  <div class="d-flex justify-content-between small">
                    <span class="text-truncate">{{ it.conta }}</span>
                    <span>{{ it.cobertura|floatformat:1 }}%</span>
                  </div>
                  <div class="progress mb-2" role="progressbar"
                       aria-valuenow="{{ it.cobertura|floatformat:1 }}" aria-valuemin="0" aria-valuemax="100"
                       style="height:.5rem;">
                    <div class="progress-bar" style="width: {{ it.cobertura|floatformat:1 }}%;"></div>
                  </div>
                {% endfor %}
              {% else %}
                <p class="text-muted mb-0">Sem contas para exibir.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Top 5 tipos de divergência -->
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="card-header"><h3 class="h6 mb-0">Top 5 tipos de divergência</h3></div>
            <div class="card-body">
              {% if graficos.top_tipos and graficos.top_tipos.0.qtd %}
                {% for it in graficos.top_tipos %}
                  {% if it.rotulo and it.rotulo|lower != 'divergência (não classificada)' %}
                    {% widthratio it.qtd graficos.top_tipos.0.qtd 100 as pct %}
                    <div class="d-flex justify-content-between small">
                      <span class="text-truncate">{{ it.rotulo }}</span>
                      <span>{{ it.qtd }}</span>
                    </div>
                    <div class="progress mb-2" role="progressbar" aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100" style="height:.5rem;">
                      <div class="progress-bar" style="width: {{ pct }}%;"></div>
                    </div>
                  {% endif %}
                {% endfor %}
              {% else %}
                <p class="text-muted mb-0">Sem divergências suficientes para exibir.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Top 5 blocos com pendências -->
        <div class="col-md-12 col-lg-4">
          <div class="card h-100">
            <div class="card-header"><h3 class="h6 mb-0">Top 5 blocos com pendências</h3></div>
            <div class="card-body">
              {% if graficos.top_blocos and graficos.top_blocos.0.qtd %}
                {% for it in graficos.top_blocos %}
                  {% widthratio it.qtd graficos.top_blocos.0.qtd 100 as pctb %}
                  {% if it.bloco and it.bloco != '—' %}
                    <div class="d-flex justify-content-between small">
                      <span class="text-truncate">{{ it.bloco|default:"(sem identificação)" }}</span>
                      <span>{{ it.qtd }}</span>
                    </div>
                    <div class="progress mb-2" role="progressbar" aria-valuenow="{{ pctb }}" aria-valuemin="0" aria-valuemax="100" style="height:.5rem;">
                      <div class="progress-bar" style="width: {{ pctb }}%;"></div>
                    </div>
                  {% endif %}
                {% endfor %}
              {% else %}
                <p class="text-muted mb-0">Sem pendências por bloco para exibir.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Quadro por conta (tabela) -->
      <div class="mt-4">
        <h3 class="h5">Quadro por Conta Contábil</h3>
        <div class="table-responsive">
          <table class="table table-striped table-sm align-middle w-100 tbl-sticky">
            <thead class="table-light">
              <tr>
                <th>Conta</th>
                <th class="text-end">Total SUAP</th>
                <th class="text-end">Vistoriados</th>
                <th class="text-end">Cobertura</th>
                <th class="text-end">Encontrados</th>
                <th class="text-end">Valor OK (R$)</th>
                <th class="text-end">Não-enc.</th>
                <th class="text-end">Valor Não-enc. (R$)</th>
                <th class="text-end">Divergentes</th>
                <th class="text-end">Valor Div. (R$)</th>
                <th class="text-end">Valor total (R$)</th>
                <th class="text-end">% Não-enc.</th>
              </tr>
            </thead>
            <tbody>
              {% for l in linhas %}
                {% widthratio l.qtd_nao l.qtd_total 100 as pct_nao %}
                <tr>
                  <td class="font-monospace text-nowrap">{{ l.conta_codigo }}</td>
                  <td class="text-end">{{ l.qtd_total }}</td>
                  <td class="text-end">{{ l.qtd_vist }}</td>
                  <td class="text-end">{{ l.cobertura|br_percent }}</td>
                  <td class="text-end">{{ l.qtd_ok }}</td>
                  <td class="text-end">{{ l.val_ok|br_currency }}</td>
                  <td class="text-end">{{ l.qtd_nao }}</td>
                  <td class="text-end">{{ l.val_nao|br_currency }}</td>
                  <td class="text-end">{{ l.qtd_div }}</td>
                  <td class="text-end">{{ l.val_div|br_currency }}</td>
                  <td class="text-end">{{ l.val_ok|add:l.val_nao|add:l.val_div|br_currency }}</td>
                  <td class="text-end">{{ pct_nao }}%</td>
                </tr>
              {% empty %}
                <tr><td colspan="12">Sem dados.</td></tr>
              {% endfor %}
              {% if total_row %}
                {% widthratio total_row.qtd_nao total_row.qtd_total 100 as pct_nao_total %}
                <tr class="table-secondary">
                  <td><strong>{{ total_row.conta_codigo }}</strong></td>
                  <td class="text-end"><strong>{{ total_row.qtd_total }}</strong></td>
                  <td class="text-end"><strong>{{ total_row.qtd_vist }}</strong></td>
                  <td class="text-end"><strong>{{ total_row.cobertura|br_percent }}</strong></td>
                  <td class="text-end"><strong>{{ total_row.qtd_ok }}</strong></td>
                  <td class="text-end"><strong>{{ total_row.val_ok|br_currency }}</strong></td>
                  <td class="text-end"><strong>{{ total_row.qtd_nao }}</strong></td>
                  <td class="text-end"><strong>{{ total_row.val_nao|br_currency }}</strong></td>
                  <td class="text-end"><strong>{{ total_row.qtd_div }}</strong></td>
                  <td class="text-end"><strong>{{ total_row.val_div|br_currency }}</strong></td>
                  <td class="text-end"><strong>{{ total_row.val_ok|add:total_row.val_nao|add:total_row.val_div|br_currency }}</strong></td>
                  <td class="text-end"><strong>{{ pct_nao_total }}%</strong></td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <p class="text-muted small mt-2 mb-0">
          <strong>Legendas:</strong>
          <em>Encontrados</em> = vistoriados e <u>sem divergência real</u>; 
          <em>Divergentes</em> = vistoriados com diferença SUAP × Vistoria (ex.: localização, série, etiqueta ausente); 
          <em>Não-enc.</em> = marcados como não encontrados <u>ou</u> <em>não vistoriados</em> (regra de consolidação); 
          <em>Cobertura</em> = vistoriados ÷ total SUAP; <em>Valor total</em> = OK + Não-enc. + Div.
        </p>
      </div>

      <!-- Checklist (vistoriados) + Tops de não encontrados -->
      {% if sumarios and sumarios.checklist %}
      <div class="row g-3 mt-3">
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header"><h3 class="h6 mb-0">Checklist (somente vistoriados)</h3></div>
            <div class="card-body">
              <p class="text-muted small">NI (não vistoriado) foi excluído desta tabela para evidenciar o comparativo Confere × Divergente.</p>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Item</th>
                      <th class="text-end">Confere</th>
                      <th class="text-end">Divergente</th>
                      <th class="text-end">% Diverg.</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for label, vals in sumarios.checklist.items %}
                      {% with total_vist=vals.confere|add:vals.diverge %}
                      <tr>
                        <td>{{ label }}</td>
                        <td class="text-end">{{ vals.confere }}</td>
                        <td class="text-end">{{ vals.diverge }}</td>
                        {% if total_vist > 0 %}
                          {% widthratio vals.diverge total_vist 100 as pct_div %}
                          <td class="text-end">{{ pct_div }}%</td>
                        {% else %}
                          <td class="text-end">—</td>
                        {% endif %}
                      </tr>
                      {% endwith %}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <p class="text-muted small mb-0">NI = não vistoriado (apresentado no KPI de cobertura).</p>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header"><h3 class="h6 mb-0">Não encontrados — Top 5</h3></div>
            <div class="card-body">
              <div class="row gy-2">
                <div class="col-sm-6">
                  <h4 class="h6">por Conta</h4>
                  {% if sumarios.top_nao_contas %}
                    {% for it in sumarios.top_nao_contas %}
                      {% widthratio it.qtd sumarios.top_nao_contas.0.qtd 100 as pn %}
                      <div class="d-flex justify-content-between small">
                        <span class="text-truncate">{{ it.conta }}</span>
                        <span>{{ it.qtd }}</span>
                      </div>
                      <div class="progress mb-2" role="progressbar" aria-valuenow="{{ pn }}" aria-valuemin="0" aria-valuemax="100" style="height:.5rem;">
                        <div class="progress-bar" style="width: {{ pn }}%;"></div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <p class="text-muted">Sem dados.</p>
                  {% endif %}
                </div>
                <div class="col-sm-6">
                  <h4 class="h6">por Bloco</h4>
                  {% if sumarios.top_nao_blocos %}
                    {% for it in sumarios.top_nao_blocos %}
                      {% widthratio it.qtd sumarios.top_nao_blocos.0.qtd 100 as pb %}
                      <div class="d-flex justify-content-between small">
                        <span class="text-truncate">{{ it.bloco }}</span>
                        <span>{{ it.qtd }}</span>
                      </div>
                      <div class="progress mb-2" role="progressbar" aria-valuenow="{{ pb }}" aria-valuemin="0" aria-valuemax="100" style="height:.5rem;">
                        <div class="progress-bar" style="width: {{ pb }}%;"></div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <p class="text-muted">Sem dados.</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </section>

  <!-- Encaminhamentos e Plano de Ação -->
  {% if cfg and cfg.texto_conclusao %}
  <section class="card mt-3">
    <div class="card-header"><h2 class="h5 mb-0">Encaminhamentos e Plano de Ação</h2></div>
    <div class="card-body">
      <p style="white-space: pre-wrap;">{% render_vars cfg.texto_conclusao %}</p>
    </div>
  </section>
  {% endif %}

  <!-- Assinaturas -->
  {% if cfg and cfg.assinantes %}
  <section class="card mt-3">
    <div class="card-header"><h2 class="h5 mb-0">Assinaturas</h2></div>
    <div class="card-body">
      <div class="row row-cols-1 row-cols-md-2 g-4">
        {% for a in cfg.assinantes %}
        <div class="col">
          <div class="p-3 border rounded text-center" style="min-height:120px;">
            <div style="margin-top:40px;">______________________________________________</div>
            <div><strong>{{ a.nome }}</strong></div>
            <div class="text-muted">{{ a.cargo }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Configurações (recolhidas; somem na impressão) -->
  {% if form %}
  <details class="mt-3">
    <summary>Editar configurações do relatório</summary>
    <div class="mt-2">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-3">
          <strong>Brasão/Logo</strong><br>
          {% if cfg.logo %}<img src="{{ cfg.logo.url }}" alt="Logo" style="max-width:220px; margin:6px 0;">{% endif %}
          {{ form.logo }}
        </div>
        <hr>
        <div class="mb-3"><strong>Apresentação</strong>{{ form.texto_apresentacao }}</div>
        <div class="mb-3"><strong>Metodologia</strong>{{ form.texto_metodologia }}</div>
        <div class="mb-3"><strong>Conclusão / Plano de Ação</strong>{{ form.texto_conclusao }}</div>
        <div class="mb-3">
          {{ form.assinantes_lista.label_tag }} {{ form.assinantes_lista }}
          <small class="text-muted d-block">{{ form.assinantes_lista.help_text }}</small>
        </div>
        <hr>
        <div class="mb-2">{{ form.incluir_mapa_nc }} Incluir Mapa de NC (resumo)</div>
        <div class="mb-2">{{ form.incluir_sem_registro }} Incluir Bens Sem Registro (resumo)</div>
        <div class="mb-2">{{ form.ocultar_contas_zeradas }} (aplica-se aos anexos detalhados)</div>
        <div class="mb-3">Ordenar anexos: {{ form.ordenar_anexos }}</div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" type="submit">Salvar configurações</button>
          <a class="btn btn-outline-secondary" href="#" onclick="window.print();return false;">Imprimir / Salvar como PDF</a>
        </div>
      </form>
    </div>
  </details>
  {% endif %}

</main>
{% endblock %}

<script>
  // Snapshot <canvas> -> <img> para gráficos aparecerem no PDF (se existirem canvases)
  function __preparePrintWithCharts() {
    if (window.__chartsPreparedForPrint) return;
    window.__chartsPreparedForPrint = true;

    const canvases = document.querySelectorAll('canvas');
    const backups = [];
    canvases.forEach(cv => {
      try {
        const w = cv.clientWidth || cv.width || 600;
        const h = cv.clientHeight || cv.height || 300;
        cv.setAttribute('width', w);
        cv.setAttribute('height', h);

        const img = new Image();
        img.className = 'chart-print-img';
        img.alt = 'Gráfico';
        img.src = cv.toDataURL('image/png');
        cv.insertAdjacentElement('afterend', img);
        backups.push({ img });
      } catch (e) {}
    });

    const cleanup = () => {
      backups.forEach(({ img }) => { if (img && img.parentNode) img.remove(); });
      window.__chartsPreparedForPrint = false;
      window.removeEventListener('afterprint', cleanup);
    };
    window.addEventListener('afterprint', cleanup);
  }

  if (window.matchMedia && window.matchMedia('print').addEventListener) {
    const mql = window.matchMedia('print');
    mql.addEventListener('change', e => { if (e.matches) __preparePrintWithCharts(); });
  } else {
    window.onbeforeprint = __preparePrintWithCharts;
  }
</script>
