{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .muted { color:#6c757d; }
  .legend li { margin-bottom: .25rem; }
  .tbl-sticky thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 2; }
  .sm { font-size: .9rem; }

  /* Cores sólidas (melhores na impressão) */
  .bg-ok  { background: #D8F3DC; }   /* verde claro */
  .bg-div { background: #FFF3CD; }   /* amarelo claro */
  .bg-nao { background: #FDE2E1; }   /* vermelho claro */

  /* Zebragem leve em tela */
  .table-striped tbody tr:nth-of-type(odd) { background-color: #F7F8FA; }

  /* imgs geradas a partir dos canvases (só aparecem no print) */
  .chart-print-img { display: none; max-width: 100%; height: auto; }

  /* ---------- Impressão ---------- */
  @media print {
    /* Força o navegador a manter cores de fundo no PDF */
    * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

    /* Desliga sticky no PDF (evita “tampa” branca) */
    .tbl-sticky thead th { position: static !important; top: auto !important; z-index: auto !important; }

    /* Cabeçalho/rodapé da tabela em todas as páginas */
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }

    /* Bordas e fundos sólidos */
    .table-light     { background-color: #EEF2F6 !important; }
    .table-secondary { background-color: #E9ECEF !important; }
    .table-striped tbody tr:nth-of-type(odd) { background-color: #F2F4F7 !important; }
    th, td { border-color: #9aa0a6 !important; background-clip: padding-box; }

    /* Na impressão: mostrar as imagens dos gráficos e esconder os canvases */
    canvas { display: none !important; }
    .chart-print-img { display: block !important; }
  }
</style>


{% endblock %}

{% block content %}
<main class="container-fluid py-3">
  <section class="mb-3">
    <h1 class="h4 mb-1">Inventário — Por Conta Contábil</h1>
    <div class="small text-muted mb-2">
      <strong>SEI:</strong> {{ SEI }} &nbsp;|&nbsp; <strong>Portaria:</strong> {{ PORTARIA }} &nbsp;|&nbsp; <strong>Período:</strong> {{ PERIODO }}
    </div>

    <!-- Legenda explicativa -->
    <div class="card mb-3">
      <div class="card-body py-2">
        <ul class="legend mb-0 sm">
          <li><span class="badge bg-success me-1">Encontrados</span> Vistoriados e sem divergências.</li>
          <li><span class="badge bg-warning text-dark me-1">Divergentes</span> Vistoriados com alguma divergência (localização, série, descrição, responsável, estado, etiqueta ausente, tombo divergente etc.).</li>
          <li><span class="badge bg-danger me-1">Não Encontrados</span> Marcados como não encontrados <u>ou</u> <strong>não vistoriados</strong> (incluídos conforme regra deste relatório).</li>
          <li class="muted">Cobertura = Vistoriados / Total de bens da conta × 100.</li>
        </ul>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="?export=csv">Exportar CSV</a>
      <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">Imprimir / PDF</button>
    </div>
  </section>

  <!-- Cards com gráficos -->
  <section class="row g-3 mb-3">
    <div class="col-12 col-xl-8">
      <div class="card h-100">
        <div class="card-header">Top contas — Itens por status</div>
        <div class="card-body">
          <canvas id="chTopContas" height="140"></canvas>
          <div class="small muted mt-2">Top 12 contas por total de itens. Barras empilhadas: Encontrados / Divergentes / Não Encontrados.</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-4">
      <div class="card h-100">
        <div class="card-header">Distribuição de itens (TOTAL)</div>
        <div class="card-body">
          <canvas id="chTotItens" height="160"></canvas>
          <div class="small muted mt-2">Visão geral do status no inventário.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Tabela principal -->
  <section class="table-responsive tbl-sticky">
    <table class="table table-sm table-bordered table-striped align-middle">
      <thead>
        <tr class="table-light">
          <th>Conta (código)</th>
          <th class="text-end">Total<br><span class="muted">itens</span></th>
          <th class="text-end">Vistoriados<br><span class="muted">itens</span></th>
          <th class="text-end">Cobertura<br><span class="muted">%</span></th>

          <th class="text-end bg-ok">Encontrados<br><span class="muted">itens</span></th>
          <th class="text-end bg-ok">Valor (R$)</th>

          <th class="text-end bg-div">Divergentes<br><span class="muted">itens</span></th>
          <th class="text-end bg-div">Valor (R$)</th>

          <th class="text-end bg-nao">Não Encontrados<br><span class="muted">itens</span></th>
          <th class="text-end bg-nao">Valor (R$)</th>
        </tr>
      </thead>
      <tbody>
        {% for l in linhas %}
        <tr>
          <td class="mono">{{ l.conta_codigo }}</td>
          <td class="text-end">{{ l.qtd_total }}</td>
          <td class="text-end">{{ l.qtd_vist }}</td>
          <td class="text-end">{{ l.cobertura|floatformat:1 }}</td>

          <td class="text-end bg-ok">{{ l.qtd_ok }}</td>
          <td class="text-end bg-ok">{{ l.val_ok|floatformat:2 }}</td>

          <td class="text-end bg-div">{{ l.qtd_div }}</td>
          <td class="text-end bg-div">{{ l.val_div|floatformat:2 }}</td>

          <td class="text-end bg-nao">{{ l.qtd_nao }}</td>
          <td class="text-end bg-nao">{{ l.val_nao|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="10" class="text-center text-muted">Sem dados.</td></tr>
        {% endfor %}
      </tbody>
      {% if total_row %}
      <tfoot>
        <tr class="table-secondary fw-semibold">
          <td>TOTAL</td>
          <td class="text-end">{{ total_row.qtd_total }}</td>
          <td class="text-end">{{ total_row.qtd_vist }}</td>
          <td class="text-end">{{ total_row.cobertura|floatformat:1 }}</td>

          <td class="text-end">{{ total_row.qtd_ok }}</td>
          <td class="text-end">{{ total_row.val_ok|floatformat:2 }}</td>

          <td class="text-end">{{ total_row.qtd_div }}</td>
          <td class="text-end">{{ total_row.val_div|floatformat:2 }}</td>

          <td class="text-end">{{ total_row.qtd_nao }}</td>
          <td class="text-end">{{ total_row.val_nao|floatformat:2 }}</td>
        </tr>
      </tfoot>
      {% endif %}
    </table>
    <p class="muted sm mt-2">Observação: valores usam o campo de aquisição do Bem; quando ausente, consideram R$ 0,00.</p>
  </section>
</main>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script>
  // Dados vindos do backend (views.py)
  const labels = {{ charts.top_labels|safe }};
  const dOK  = {{ charts.top_ok|safe }};
  const dDIV = {{ charts.top_div|safe }};
  const dNAO = {{ charts.top_nao|safe }};

  // Ajusta cores amigáveis (também imprimem razoavelmente)
  const C_OK  = 'rgba(25, 135, 84, 0.85)';   // bootstrap success
  const C_DIV = 'rgba(255, 193, 7, 0.85)';   // bootstrap warning
  const C_NAO = 'rgba(220, 53, 69, 0.85)';   // bootstrap danger
  const C_BORDER = 'rgba(0,0,0,.15)';

  // Barras empilhadas por conta
  const ctx1 = document.getElementById('chTopContas').getContext('2d');
  new Chart(ctx1, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {label: 'Encontrados', data: dOK,  backgroundColor: C_OK,  borderColor: C_BORDER, borderWidth: 1},
        {label: 'Divergentes', data: dDIV, backgroundColor: C_DIV, borderColor: C_BORDER, borderWidth: 1},
        {label: 'Não Encontrados', data: dNAO, backgroundColor: C_NAO, borderColor: C_BORDER, borderWidth: 1},
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      scales: {
        x: { stacked: true, ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } },
        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Itens' } }
      }
    }
  });

  // Donut de totais (itens)
  const totOK  = {{ charts.tot_itens.ok }};
  const totDIV = {{ charts.tot_itens.div }};
  const totNAO = {{ charts.tot_itens.nao }};

  const ctx2 = document.getElementById('chTotItens').getContext('2d');
  new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: ['Encontrados', 'Divergentes', 'Não Encontrados'],
      datasets: [{
        data: [totOK, totDIV, totNAO],
        backgroundColor: [C_OK, C_DIV, C_NAO],
        borderColor: C_BORDER,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      cutout: '55%'
    }
  });
</script>
{% endblock %}
